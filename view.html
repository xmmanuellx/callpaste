<!DOCTYPE html>
<html lang="es" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallPaste - Lista de Contactos</title>
    <meta name="description" content="Lista de nÃºmeros de telÃ©fono compartida via CallPaste.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css?v=GLOBAL_FIX_2026">
    <style>
        /* View-specific styles */
        .view-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1.5rem;
            padding-bottom: 120px;
            /* Always allow space for player controls */
            min-height: 100vh;
        }

        .view-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .view-list {
            margin-bottom: 2rem;
        }

        .view-footer {
            text-align: center;
            padding: 1.5rem 0;
            border-top: 1px solid var(--border);
        }

        .view-footer a {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.75rem;
        }

        .view-footer a:hover {
            color: var(--text);
        }

        /* HARDCORE SLIM MODE FIXES - Injected to bypass cache/specificity issues */
        body.slim-mode .view-list {
            border-top: 1px solid var(--border);
        }

        body.slim-mode .phone-line,
        body.slim-mode .text-line {
            height: 38px !important;
            min-height: 38px !important;
            max-height: 38px !important;
            padding: 0 0.5rem !important;
            margin: 0 !important;
            border-radius: 0 !important;
            border: none !important;
            border-bottom: 1px solid var(--border) !important;
            display: flex !important;
            align-items: center !important;
            animation: none !important;
            transform: none !important;
            background-color: transparent !important;
            /* FIX: Unify visual background */
        }

        body.slim-mode .phone-line:hover,
        body.slim-mode .text-line:hover {
            background-color: rgba(128, 128, 128, 0.05) !important;
            /* Subtle hover */
        }

        body.slim-mode .phone-line:last-child,
        body.slim-mode .text-line:last-child {
            border-bottom: none !important;
        }

        body.slim-mode .phone-content,
        body.slim-mode .line-actions {
            height: 38px !important;
            display: flex !important;
            align-items: center !important;
        }

        /* Fix text line alignment */
        body.slim-mode .text-line {
            border-left: none !important;
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding-left: 0.75rem !important;
            /* FIX: Better visual alignment with phone lines */
            justify-content: flex-start;
        }

        /* Touched override */
        body.slim-mode .phone-line.touched {
            background-color: rgba(34, 197, 94, 0.15) !important;
            border-left: 4px solid #22c55e !important;
            padding-left: calc(0.5rem - 4px) !important;
            box-shadow: none !important;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-state h2 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        /* Phone lines in view mode */
        .view-list .phone-line {
            cursor: pointer;
        }

        /* Player Mode Styles - Always Visible */
        .player-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            z-index: 1000;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .player-btn {
            flex: 1;
            max-width: 180px;
            height: 56px;
            border-radius: 28px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .player-btn.primary,
        .player-btn.secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 2px solid var(--text);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .player-btn.primary:hover,
        .player-btn.secondary:hover {
            background: var(--text);
            color: var(--bg);
        }

        .player-btn:active {
            transform: scale(0.96);
        }

        /* Highlight active line more in player mode */
        body.player-mode .phone-line.touched {
            border-left: 6px solid var(--primary) !important;
            background-color: rgba(37, 99, 235, 0.1) !important;
        }
    </style>
</head>

<body>
    <div class="view-container">
        <!-- Header -->
        <header class="view-header"
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <div class="header-info" style="text-align: left;">
                <h1 style="font-size: 1.5rem; margin-bottom: 0.25rem;">Lista</h1>
                <p id="item-count" style="font-size: 0.875rem; color: var(--text-secondary);">Cargando...</p>
            </div>

            <div class="header-controls" style="display: flex; gap: 0.5rem;">
                <button id="view-mode-toggle" class="theme-toggle" title="Modo Compacto/Normal">
                    <span class="icon-list">â˜°</span>
                </button>
                <button id="theme-toggle" class="theme-toggle" title="Cambiar tema">
                    <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Phone List -->
        <div class="view-list" id="phone-list">
            <div class="empty-state">
                <h2>Sin contenido</h2>
                <p>No hay nÃºmeros para mostrar.</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="view-footer">
            <a href="index.html">Crear tu propia lista â†’ CallPaste</a>
        </footer>
    </div>

    <!-- Player Controls (Hidden by default, shown in Player Mode) -->
    <div class="player-controls">
        <button id="btn-repeat" class="player-btn secondary">
            <span style="font-size: 1.2rem;">â†º</span> Repetir
        </button>
        <button id="btn-next" class="player-btn primary">
            Siguiente <span style="font-size: 1.2rem;">â–¶</span>
        </button>
    </div>

    <!-- LZString for decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCu63MurDRSFN210covePBXymjq1zIw3to",
            authDomain: "callpaste-app-2026.firebaseapp.com",
            projectId: "callpaste-app-2026",
            storageBucket: "callpaste-app-2026.firebasestorage.app",
            messagingSenderId: "578605796686",
            appId: "1:578605796686:web:cbe878be1547cc891be21f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        // State
        var currentListId = null;
        var unsubscribeVotes = null;
    </script>
    <script>
        // Country codes dictionary (sorted by length for proper matching)
        const countryCodes = {
            // North America
            '1': { name: 'USA/CA', flag: 'ðŸ‡ºðŸ‡¸' },
            // Caribbean & Central America
            '1809': { name: 'RD', flag: 'ðŸ‡©ðŸ‡´' },
            '1829': { name: 'RD', flag: 'ðŸ‡©ðŸ‡´' },
            '1849': { name: 'RD', flag: 'ðŸ‡©ðŸ‡´' },
            '1787': { name: 'PR', flag: 'ðŸ‡µðŸ‡·' },
            '1939': { name: 'PR', flag: 'ðŸ‡µðŸ‡·' },
            '1876': { name: 'Jamaica', flag: 'ðŸ‡¯ðŸ‡²' },
            '1868': { name: 'Trinidad y Tobago', flag: 'ðŸ‡¹ðŸ‡¹' },
            '1246': { name: 'Barbados', flag: 'ðŸ‡§ðŸ‡§' },
            '1242': { name: 'Bahamas', flag: 'ðŸ‡§ðŸ‡¸' },
            '1345': { name: 'Islas CaimÃ¡n', flag: 'ðŸ‡°ðŸ‡¾' },
            '1441': { name: 'Bermudas', flag: 'ðŸ‡§ðŸ‡²' },
            '1473': { name: 'Granada', flag: 'ðŸ‡¬ðŸ‡©' },
            '1649': { name: 'Islas Turcas y Caicos', flag: 'ðŸ‡¹ðŸ‡¨' },
            '1664': { name: 'Montserrat', flag: 'ðŸ‡²ðŸ‡¸' },
            '1670': { name: 'Islas Marianas', flag: 'ðŸ‡²ðŸ‡µ' },
            '1671': { name: 'Guam', flag: 'ðŸ‡¬ðŸ‡º' },
            '1684': { name: 'Samoa Americana', flag: 'ðŸ‡¦ðŸ‡¸' },
            '1721': { name: 'Sint Maarten', flag: 'ðŸ‡¸ðŸ‡½' },
            '1758': { name: 'Santa LucÃ­a', flag: 'ðŸ‡±ðŸ‡¨' },
            '1767': { name: 'Dominica', flag: 'ðŸ‡©ðŸ‡²' },
            '1784': { name: 'San Vicente', flag: 'ðŸ‡»ðŸ‡¨' },
            '1869': { name: 'San CristÃ³bal y Nieves', flag: 'ðŸ‡°ðŸ‡³' },
            '1284': { name: 'Islas VÃ­rgenes BritÃ¡nicas', flag: 'ðŸ‡»ðŸ‡¬' },
            '1340': { name: 'Islas VÃ­rgenes EEUU', flag: 'ðŸ‡»ðŸ‡®' },
            // South America  
            '54': { name: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·' },
            '55': { name: 'Brasil', flag: 'ðŸ‡§ðŸ‡·' },
            '56': { name: 'Chile', flag: 'ðŸ‡¨ðŸ‡±' },
            '57': { name: 'Colombia', flag: 'ðŸ‡¨ðŸ‡´' },
            '58': { name: 'Venezuela', flag: 'ðŸ‡»ðŸ‡ª' },
            '51': { name: 'PerÃº', flag: 'ðŸ‡µðŸ‡ª' },
            '52': { name: 'MÃ©xico', flag: 'ðŸ‡²ðŸ‡½' },
            '53': { name: 'Cuba', flag: 'ðŸ‡¨ðŸ‡º' },
            '591': { name: 'Bolivia', flag: 'ðŸ‡§ðŸ‡´' },
            '592': { name: 'Guyana', flag: 'ðŸ‡¬ðŸ‡¾' },
            '593': { name: 'Ecuador', flag: 'ðŸ‡ªðŸ‡¨' },
            '594': { name: 'Guyana Francesa', flag: 'ðŸ‡¬ðŸ‡«' },
            '595': { name: 'Paraguay', flag: 'ðŸ‡µðŸ‡¾' },
            '597': { name: 'Surinam', flag: 'ðŸ‡¸ðŸ‡·' },
            '598': { name: 'Uruguay', flag: 'ðŸ‡ºðŸ‡¾' },
            // Central America
            '501': { name: 'Belice', flag: 'ðŸ‡§ðŸ‡¿' },
            '502': { name: 'Guatemala', flag: 'ðŸ‡¬ðŸ‡¹' },
            '503': { name: 'El Salvador', flag: 'ðŸ‡¸ðŸ‡»' },
            '504': { name: 'Honduras', flag: 'ðŸ‡­ðŸ‡³' },
            '505': { name: 'Nicaragua', flag: 'ðŸ‡³ðŸ‡®' },
            '506': { name: 'Costa Rica', flag: 'ðŸ‡¨ðŸ‡·' },
            '507': { name: 'PanamÃ¡', flag: 'ðŸ‡µðŸ‡¦' },
            '509': { name: 'HaitÃ­', flag: 'ðŸ‡­ðŸ‡¹' },
            // Europe
            '30': { name: 'Grecia', flag: 'ðŸ‡¬ðŸ‡·' },
            '31': { name: 'PaÃ­ses Bajos', flag: 'ðŸ‡³ðŸ‡±' },
            '32': { name: 'BÃ©lgica', flag: 'ðŸ‡§ðŸ‡ª' },
            '33': { name: 'Francia', flag: 'ðŸ‡«ðŸ‡·' },
            '34': { name: 'EspaÃ±a', flag: 'ðŸ‡ªðŸ‡¸' },
            '36': { name: 'HungrÃ­a', flag: 'ðŸ‡­ðŸ‡º' },
            '37': { name: 'Lituania', flag: 'ðŸ‡±ðŸ‡¹' },
            '39': { name: 'Italia', flag: 'ðŸ‡®ðŸ‡¹' },
            '40': { name: 'Rumania', flag: 'ðŸ‡·ðŸ‡´' },
            '41': { name: 'Suiza', flag: 'ðŸ‡¨ðŸ‡­' },
            '43': { name: 'Austria', flag: 'ðŸ‡¦ðŸ‡¹' },
            '44': { name: 'Reino Unido', flag: 'ðŸ‡¬ðŸ‡§' },
            '45': { name: 'Dinamarca', flag: 'ðŸ‡©ðŸ‡°' },
            '46': { name: 'Suecia', flag: 'ðŸ‡¸ðŸ‡ª' },
            '47': { name: 'Noruega', flag: 'ðŸ‡³ðŸ‡´' },
            '48': { name: 'Polonia', flag: 'ðŸ‡µðŸ‡±' },
            '49': { name: 'Alemania', flag: 'ðŸ‡©ðŸ‡ª' },
            '350': { name: 'Gibraltar', flag: 'ðŸ‡¬ðŸ‡®' },
            '351': { name: 'Portugal', flag: 'ðŸ‡µðŸ‡¹' },
            '352': { name: 'Luxemburgo', flag: 'ðŸ‡±ðŸ‡º' },
            '353': { name: 'Irlanda', flag: 'ðŸ‡®ðŸ‡ª' },
            '354': { name: 'Islandia', flag: 'ðŸ‡®ðŸ‡¸' },
            '355': { name: 'Albania', flag: 'ðŸ‡¦ðŸ‡±' },
            '356': { name: 'Malta', flag: 'ðŸ‡²ðŸ‡¹' },
            '357': { name: 'Chipre', flag: 'ðŸ‡¨ðŸ‡¾' },
            '358': { name: 'Finlandia', flag: 'ðŸ‡«ðŸ‡®' },
            '359': { name: 'Bulgaria', flag: 'ðŸ‡§ðŸ‡¬' },
            '370': { name: 'Lituania', flag: 'ðŸ‡±ðŸ‡¹' },
            '371': { name: 'Letonia', flag: 'ðŸ‡±ðŸ‡»' },
            '372': { name: 'Estonia', flag: 'ðŸ‡ªðŸ‡ª' },
            '373': { name: 'Moldavia', flag: 'ðŸ‡²ðŸ‡©' },
            '374': { name: 'Armenia', flag: 'ðŸ‡¦ðŸ‡²' },
            '375': { name: 'Bielorrusia', flag: 'ðŸ‡§ðŸ‡¾' },
            '376': { name: 'Andorra', flag: 'ðŸ‡¦ðŸ‡©' },
            '377': { name: 'MÃ³naco', flag: 'ðŸ‡²ðŸ‡¨' },
            '378': { name: 'San Marino', flag: 'ðŸ‡¸ðŸ‡²' },
            '380': { name: 'Ucrania', flag: 'ðŸ‡ºðŸ‡¦' },
            '381': { name: 'Serbia', flag: 'ðŸ‡·ðŸ‡¸' },
            '382': { name: 'Montenegro', flag: 'ðŸ‡²ðŸ‡ª' },
            '383': { name: 'Kosovo', flag: 'ðŸ‡½ðŸ‡°' },
            '385': { name: 'Croacia', flag: 'ðŸ‡­ðŸ‡·' },
            '386': { name: 'Eslovenia', flag: 'ðŸ‡¸ðŸ‡®' },
            '387': { name: 'Bosnia', flag: 'ðŸ‡§ðŸ‡¦' },
            '389': { name: 'Macedonia del Norte', flag: 'ðŸ‡²ðŸ‡°' },
            '420': { name: 'Chequia', flag: 'ðŸ‡¨ðŸ‡¿' },
            '421': { name: 'Eslovaquia', flag: 'ðŸ‡¸ðŸ‡°' },
            // Asia
            '7': { name: 'Rusia/KazajistÃ¡n', flag: 'ðŸ‡·ðŸ‡º' },
            '60': { name: 'Malasia', flag: 'ðŸ‡²ðŸ‡¾' },
            '61': { name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º' },
            '62': { name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
            '63': { name: 'Filipinas', flag: 'ðŸ‡µðŸ‡­' },
            '64': { name: 'Nueva Zelanda', flag: 'ðŸ‡³ðŸ‡¿' },
            '65': { name: 'Singapur', flag: 'ðŸ‡¸ðŸ‡¬' },
            '66': { name: 'Tailandia', flag: 'ðŸ‡¹ðŸ‡­' },
            '81': { name: 'JapÃ³n', flag: 'ðŸ‡¯ðŸ‡µ' },
            '82': { name: 'Corea del Sur', flag: 'ðŸ‡°ðŸ‡·' },
            '84': { name: 'Vietnam', flag: 'ðŸ‡»ðŸ‡³' },
            '86': { name: 'China', flag: 'ðŸ‡¨ðŸ‡³' },
            '90': { name: 'TurquÃ­a', flag: 'ðŸ‡¹ðŸ‡·' },
            '91': { name: 'India', flag: 'ðŸ‡®ðŸ‡³' },
            '92': { name: 'PakistÃ¡n', flag: 'ðŸ‡µðŸ‡°' },
            '93': { name: 'AfganistÃ¡n', flag: 'ðŸ‡¦ðŸ‡«' },
            '94': { name: 'Sri Lanka', flag: 'ðŸ‡±ðŸ‡°' },
            '95': { name: 'Myanmar', flag: 'ðŸ‡²ðŸ‡²' },
            '98': { name: 'IrÃ¡n', flag: 'ðŸ‡®ðŸ‡·' },
            '852': { name: 'Hong Kong', flag: 'ðŸ‡­ðŸ‡°' },
            '853': { name: 'Macao', flag: 'ðŸ‡²ðŸ‡´' },
            '855': { name: 'Camboya', flag: 'ðŸ‡°ðŸ‡­' },
            '856': { name: 'Laos', flag: 'ðŸ‡±ðŸ‡¦' },
            '880': { name: 'Bangladesh', flag: 'ðŸ‡§ðŸ‡©' },
            '886': { name: 'TaiwÃ¡n', flag: 'ðŸ‡¹ðŸ‡¼' },
            // Middle East
            '962': { name: 'Jordania', flag: 'ðŸ‡¯ðŸ‡´' },
            '963': { name: 'Siria', flag: 'ðŸ‡¸ðŸ‡¾' },
            '964': { name: 'Irak', flag: 'ðŸ‡®ðŸ‡¶' },
            '965': { name: 'Kuwait', flag: 'ðŸ‡°ðŸ‡¼' },
            '966': { name: 'Arabia Saudita', flag: 'ðŸ‡¸ðŸ‡¦' },
            '967': { name: 'Yemen', flag: 'ðŸ‡¾ðŸ‡ª' },
            '968': { name: 'OmÃ¡n', flag: 'ðŸ‡´ðŸ‡²' },
            '970': { name: 'Palestina', flag: 'ðŸ‡µðŸ‡¸' },
            '971': { name: 'Emiratos Ãrabes', flag: 'ðŸ‡¦ðŸ‡ª' },
            '972': { name: 'Israel', flag: 'ðŸ‡®ðŸ‡±' },
            '973': { name: 'BarÃ©in', flag: 'ðŸ‡§ðŸ‡­' },
            '974': { name: 'Catar', flag: 'ðŸ‡¶ðŸ‡¦' },
            '975': { name: 'ButÃ¡n', flag: 'ðŸ‡§ðŸ‡¹' },
            '976': { name: 'Mongolia', flag: 'ðŸ‡²ðŸ‡³' },
            '977': { name: 'Nepal', flag: 'ðŸ‡³ðŸ‡µ' },
            // Africa
            '20': { name: 'Egipto', flag: 'ðŸ‡ªðŸ‡¬' },
            '27': { name: 'SudÃ¡frica', flag: 'ðŸ‡¿ðŸ‡¦' },
            '211': { name: 'SudÃ¡n del Sur', flag: 'ðŸ‡¸ðŸ‡¸' },
            '212': { name: 'Marruecos', flag: 'ðŸ‡²ðŸ‡¦' },
            '213': { name: 'Argelia', flag: 'ðŸ‡©ðŸ‡¿' },
            '216': { name: 'TÃºnez', flag: 'ðŸ‡¹ðŸ‡³' },
            '218': { name: 'Libia', flag: 'ðŸ‡±ðŸ‡¾' },
            '220': { name: 'Gambia', flag: 'ðŸ‡¬ðŸ‡²' },
            '221': { name: 'Senegal', flag: 'ðŸ‡¸ðŸ‡³' },
            '222': { name: 'Mauritania', flag: 'ðŸ‡²ðŸ‡·' },
            '223': { name: 'MalÃ­', flag: 'ðŸ‡²ðŸ‡±' },
            '224': { name: 'Guinea', flag: 'ðŸ‡¬ðŸ‡³' },
            '225': { name: 'Costa de Marfil', flag: 'ðŸ‡¨ðŸ‡®' },
            '226': { name: 'Burkina Faso', flag: 'ðŸ‡§ðŸ‡«' },
            '227': { name: 'NÃ­ger', flag: 'ðŸ‡³ðŸ‡ª' },
            '228': { name: 'Togo', flag: 'ðŸ‡¹ðŸ‡¬' },
            '229': { name: 'BenÃ­n', flag: 'ðŸ‡§ðŸ‡¯' },
            '230': { name: 'Mauricio', flag: 'ðŸ‡²ðŸ‡º' },
            '231': { name: 'Liberia', flag: 'ðŸ‡±ðŸ‡·' },
            '232': { name: 'Sierra Leona', flag: 'ðŸ‡¸ðŸ‡±' },
            '233': { name: 'Ghana', flag: 'ðŸ‡¬ðŸ‡­' },
            '234': { name: 'Nigeria', flag: 'ðŸ‡³ðŸ‡¬' },
            '235': { name: 'Chad', flag: 'ðŸ‡¹ðŸ‡©' },
            '236': { name: 'Rep. Centroafricana', flag: 'ðŸ‡¨ðŸ‡«' },
            '237': { name: 'CamerÃºn', flag: 'ðŸ‡¨ðŸ‡²' },
            '238': { name: 'Cabo Verde', flag: 'ðŸ‡¨ðŸ‡»' },
            '239': { name: 'Santo TomÃ©', flag: 'ðŸ‡¸ðŸ‡¹' },
            '240': { name: 'Guinea Ecuatorial', flag: 'ðŸ‡¬ðŸ‡¶' },
            '241': { name: 'GabÃ³n', flag: 'ðŸ‡¬ðŸ‡¦' },
            '242': { name: 'Congo', flag: 'ðŸ‡¨ðŸ‡¬' },
            '243': { name: 'RD Congo', flag: 'ðŸ‡¨ðŸ‡©' },
            '244': { name: 'Angola', flag: 'ðŸ‡¦ðŸ‡´' },
            '245': { name: 'Guinea-BisÃ¡u', flag: 'ðŸ‡¬ðŸ‡¼' },
            '246': { name: 'Diego GarcÃ­a', flag: 'ðŸ‡®ðŸ‡´' },
            '247': { name: 'AscensiÃ³n', flag: 'ðŸ‡¦ðŸ‡¨' },
            '248': { name: 'Seychelles', flag: 'ðŸ‡¸ðŸ‡¨' },
            '249': { name: 'SudÃ¡n', flag: 'ðŸ‡¸ðŸ‡©' },
            '250': { name: 'Ruanda', flag: 'ðŸ‡·ðŸ‡¼' },
            '251': { name: 'EtiopÃ­a', flag: 'ðŸ‡ªðŸ‡¹' },
            '252': { name: 'Somalia', flag: 'ðŸ‡¸ðŸ‡´' },
            '253': { name: 'Yibuti', flag: 'ðŸ‡©ðŸ‡¯' },
            '254': { name: 'Kenia', flag: 'ðŸ‡°ðŸ‡ª' },
            '255': { name: 'Tanzania', flag: 'ðŸ‡¹ðŸ‡¿' },
            '256': { name: 'Uganda', flag: 'ðŸ‡ºðŸ‡¬' },
            '257': { name: 'Burundi', flag: 'ðŸ‡§ðŸ‡®' },
            '258': { name: 'Mozambique', flag: 'ðŸ‡²ðŸ‡¿' },
            '260': { name: 'Zambia', flag: 'ðŸ‡¿ðŸ‡²' },
            '261': { name: 'Madagascar', flag: 'ðŸ‡²ðŸ‡¬' },
            '262': { name: 'ReuniÃ³n', flag: 'ðŸ‡·ðŸ‡ª' },
            '263': { name: 'Zimbabue', flag: 'ðŸ‡¿ðŸ‡¼' },
            '264': { name: 'Namibia', flag: 'ðŸ‡³ðŸ‡¦' },
            '265': { name: 'Malaui', flag: 'ðŸ‡²ðŸ‡¼' },
            '266': { name: 'Lesoto', flag: 'ðŸ‡±ðŸ‡¸' },
            '267': { name: 'Botsuana', flag: 'ðŸ‡§ðŸ‡¼' },
            '268': { name: 'Esuatini', flag: 'ðŸ‡¸ðŸ‡¿' },
            '269': { name: 'Comoras', flag: 'ðŸ‡°ðŸ‡²' },
            '290': { name: 'Santa Elena', flag: 'ðŸ‡¸ðŸ‡­' },
            '291': { name: 'Eritrea', flag: 'ðŸ‡ªðŸ‡·' },
            '297': { name: 'Aruba', flag: 'ðŸ‡¦ðŸ‡¼' },
            '298': { name: 'Islas Feroe', flag: 'ðŸ‡«ðŸ‡´' },
            '299': { name: 'Groenlandia', flag: 'ðŸ‡¬ðŸ‡±' },
        };

        function getCountryFromPhone(phone) {
            let cleaned = phone.replace(/[^\d]/g, '');
            for (let length = 4; length >= 1; length--) {
                const prefix = cleaned.substring(0, length);
                if (countryCodes[prefix]) {
                    return countryCodes[prefix];
                }
            }
            return null;
        }

        function isPhoneNumber(str) {
            const cleaned = str.replace(/[\s\-\(\)\+\.]/g, '');
            const digitCount = (cleaned.match(/\d/g) || []).length;
            return digitCount >= 7 && digitCount <= 15;
        }

        function formatPhoneForLink(phone) {
            return phone.replace(/[^\d\+]/g, '');
        }

        function getIsoFromName(name) {
            // Simple heuristic updates
            if (name.includes('Unidos') || name.includes('United')) return 'US';
            if (name.includes('Dominicana')) return 'DO';
            if (name.includes('MÃ©xico')) return 'MX';
            if (name.includes('EspaÃ±a')) return 'ES';
            if (name.includes('Colombia')) return 'CO';
            if (name.includes('Argentina')) return 'AR';
            if (name.includes('Venezuela')) return 'VE';
            if (name.includes('PerÃº')) return 'PE';
            if (name.includes('Chile')) return 'CL';

            // Fallback: First letters of first 2 words
            return name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        }

        // View Mode Logic: Normal -> Slim -> Grid -> Normal
        const MODES = ['normal', 'slim', 'grid'];
        const ICONS = { 'normal': 'â˜°', 'slim': 'â˜²', 'grid': 'âŠž' };

        function toggleViewMode() {
            const body = document.body;
            let currentMode = localStorage.getItem('viewMode') || 'normal';

            // Find next mode
            let currentIndex = MODES.indexOf(currentMode);
            let nextIndex = (currentIndex + 1) % MODES.length;
            let nextMode = MODES[nextIndex];

            // Update DOM classes
            MODES.forEach(m => body.classList.remove(`${m}-mode`));
            if (nextMode !== 'normal') {
                body.classList.add(`${nextMode}-mode`);
            }

            // Update Icon
            const btn = document.getElementById('view-mode-toggle');
            btn.innerHTML = `<span class="icon-view">${ICONS[nextMode]}</span>`;

            localStorage.setItem('viewMode', nextMode);
        }

        function loadViewMode() {
            const savedMode = localStorage.getItem('viewMode') || 'normal';
            const body = document.body;

            MODES.forEach(m => body.classList.remove(`${m}-mode`));
            if (savedMode !== 'normal') {
                body.classList.add(`${savedMode}-mode`);
            }

            // Update Icon
            const btn = document.getElementById('view-mode-toggle');
            if (btn) btn.innerHTML = `<span class="icon-view">${ICONS[savedMode]}</span>`;
        }

        async function loadContent() {
            // Reset scroll position when loading new content
            window.scrollTo(0, 0);

            const hash = window.location.hash.slice(1);
            const listContainer = document.getElementById('phone-list');
            const itemCount = document.getElementById('item-count');

            if (!hash) {
                return;
            }

            try {
                let decoded;

                // Try LZString decompression first (compressed format)
                if (typeof LZString !== 'undefined') {
                    decoded = LZString.decompressFromEncodedURIComponent(hash);
                }

                // Fallback to base64 if decompression didn't work (old format)
                // LZString returns null if it fails to decompress
                if (!decoded) {
                    try {
                        decoded = decodeURIComponent(escape(atob(decodeURIComponent(hash))));
                    } catch (e) {
                        // Ignore base64 error if LZString already failed
                    }
                }

                if (!decoded) {
                    itemCount.textContent = 'Sin contenido';
                    return;
                }

                const lines = decoded.split('\n').filter(line => line.trim() !== '');

                if (lines.length === 0) {
                    return;
                }

                itemCount.textContent = `${lines.length} nÃºmero${lines.length !== 1 ? 's' : ''}`;

                let html = '';
                lines.forEach((line, index) => {
                    const trimmedLine = line.trim();
                    const lineNum = index + 1;

                    if (isPhoneNumber(trimmedLine)) {
                        const phoneLink = formatPhoneForLink(trimmedLine);
                        const country = getCountryFromPhone(phoneLink);

                        let countryBadge = '';
                        if (country) {
                            const iso = getIsoFromName(country.name);
                            countryBadge = `<span class="country-badge">
                                ${country.flag} 
                                <span class="country-name-text">${country.name}</span>
                                <span class="country-iso-text" style="display:none">${iso}</span>
                            </span>`;
                        }

                        html += `
                            <div class="phone-line" data-tel="${phoneLink}">
                                <div class="phone-content">
                                    <span class="line-number">${lineNum}</span>
                                    <span class="phone-link">${trimmedLine}</span>
                                </div>
                                <div class="line-actions">
                                    ${countryBadge}
                                    <span class="connection-counter" title="Conexiones exitosas">0</span>
                                    <div class="vote-buttons">
                                        <button class="vote-btn downvote" title="No funciona">â–¼</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `<div class="text-line"><span class="line-number">${lineNum}</span>${trimmedLine}</div>`;
                    }
                });

                listContainer.innerHTML = html;

                // Generate List ID for DB
                generateListId(lines).then(id => {
                    currentListId = id;
                    subscribeToVotes(id);
                });

                // Add click handlers
                addClickHandlers();

            } catch (e) {
                console.error('Error decoding content:', e);
                itemCount.textContent = 'Error al cargar contenido';
            }
        }

        function addClickHandlers() {
            const phoneLines = document.querySelectorAll('.phone-line');

            phoneLines.forEach(line => {
                const tel = line.getAttribute('data-tel');

                // Line click - make call
                line.addEventListener('click', function (e) {
                    if (e.target.classList.contains('vote-btn')) {
                        return; // Don't call if clicking vote buttons
                    }

                    // Remove 'touched' class from all lines
                    phoneLines.forEach(l => l.classList.remove('touched'));
                    // Add 'touched' class to the clicked line
                    this.classList.add('touched');

                    // Auto-scroll focused item to center (UX Improvement)
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    if (tel) {
                        // Log attempt (increment click count)
                        castVote(tel, 'attempt');
                        window.location.href = 'tel:' + tel;
                    }
                });

                // Vote buttons
                const upvoteBtn = line.querySelector('.vote-btn.upvote');
                const downvoteBtn = line.querySelector('.vote-btn.downvote');

                if (upvoteBtn) {
                    // Upvote button removed in favor of auto-counter or manual add logic if needed
                    // keeping variable if we want to re-add, but UI changed above.
                    // Actually, let's keep it simply hidden or use the counter itself as the indicator.
                    // For now, based on user request, "green" is connections.
                }

                if (downvoteBtn) {
                    downvoteBtn.addEventListener('click', function (e) {
                        e.stopPropagation();
                        // Toggle ghost status
                        const isGhost = line.classList.contains('ghost-mode');
                        // If it WAS ghost, we remove it (neutral). If not, we make it ghost.
                        castVote(tel, isGhost ? 'neutral' : 'down');
                    });
                }
            });
        }

        // --- Firebase Logic ---

        // Hash content to get a stable List ID
        async function generateListId(lines) {
            // Join lines and hash
            const content = lines.map(l => l.trim()).join('|');
            const encoder = new TextEncoder();
            const data = encoder.encode(content);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex.substring(0, 16); // Short hash
        }

        // Subscribe to votes
        function subscribeToVotes(listId) {
            if (unsubscribeVotes) unsubscribeVotes(); // Unsubscribe prev
            if (typeof db === 'undefined') return;

            const docRef = db.collection('lists').doc(listId);

            unsubscribeVotes = docRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    applyVotes(data.votes || {});
                }
            }, (error) => {
                console.error("Error suscribiendo:", error);
            });
        }

        // Apply votes/counts to UI
        function applyVotes(votesMap) {
            const lines = document.querySelectorAll('.phone-line');
            lines.forEach(line => {
                const tel = line.getAttribute('data-tel');
                if (!tel) return;

                const data = votesMap[tel] || {}; // Object {status: 'down'|'neutral', count: 0}

                const downBtn = line.querySelector('.vote-btn.downvote');
                const counterBadge = line.querySelector('.connection-counter');

                // Reset
                line.classList.remove('ghost-mode');
                downBtn.classList.remove('active');

                const status = data.status || 'neutral';
                const count = data.count || 0;
                const attempts = data.attempts || 0;

                // LOGIC MAP IMPLEMENTATION
                // 1. Ghost Mode Logic
                //    - Manual Downvote
                //    - Automatic Fatigue: >10 attempts AND 0 successes
                let isGhost = false;

                if (status === 'down') {
                    isGhost = true;
                } else if (attempts > 10 && count === 0) {
                    isGhost = true;
                    // Optional: We could update DB status to 'down' here to make it permanent, 
                    // but calculating it on client is non-destructive (allows recovery if count > 0 later).
                    // Let's stick to visual/functional ghosting.
                }

                if (isGhost) {
                    line.classList.add('ghost-mode');
                    // Only activate button if manually downvoted, or maybe distinct style?
                    // Let's activate it to show why it's ghosted.
                    downBtn.classList.add('active');
                }

                // 2. Connection Counter Logic
                if (count > 0) {
                    counterBadge.textContent = `${count}`;
                    counterBadge.classList.add('visible');
                    // Green highlight for successful lines
                    // (Override ghost if it somehow has count > 0, though logic prevents auto-ghost in that case)
                    if (!isGhost) {
                        line.style.borderLeft = '3px solid #22c55e';
                    }
                } else {
                    counterBadge.classList.remove('visible');
                    if (!isGhost) line.style.borderLeft = '';
                }
            });
        }

        // Write vote/count to DB
        // action: 'increment' (success), 'attempt' (try), 'down' (block), 'neutral' (reset)
        function castVote(phone, action) {
            if (!currentListId) return;

            const docRef = db.collection('lists').doc(currentListId);

            const updateData = {};

            if (action === 'increment') {
                // SUCCESS: +1 count
                updateData[`votes.${phone}.count`] = firebase.firestore.FieldValue.increment(1);
                updateData[`votes.${phone}.status`] = 'neutral';
            }
            else if (action === 'attempt') {
                // ATTEMPT: +1 attempts
                updateData[`votes.${phone}.attempts`] = firebase.firestore.FieldValue.increment(1);
            }
            else if (action === 'down') {
                updateData[`votes.${phone}.status`] = 'down';
            }
            else if (action === 'neutral') {
                updateData[`votes.${phone}.status`] = 'neutral';
            }

            // Add TTL expiration (24 hours from now)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            updateData.expiresAt = firebase.firestore.Timestamp.fromDate(tomorrow);

            // Use update() so dot notation creates nested objects
            // If doc doesn't exist, update fails - so we catch and use set()
            docRef.update(updateData)
                .catch(err => {
                    if (err.code === 'not-found') {
                        // Document doesn't exist, create it with set
                        const initialData = {
                            votes: {
                                [phone]: {}
                            },
                            expiresAt: updateData.expiresAt
                        };
                        // Set initial values based on action
                        if (action === 'increment') {
                            initialData.votes[phone] = { count: 1, status: 'neutral' };
                        } else if (action === 'attempt') {
                            initialData.votes[phone] = { attempts: 1 };
                        } else if (action === 'down') {
                            initialData.votes[phone] = { status: 'down' };
                        } else {
                            initialData.votes[phone] = { status: 'neutral' };
                        }
                        docRef.set(initialData);
                    } else {
                        console.error("Error voting:", err);
                    }
                });
        }

        function showToast(message, duration = 3000) {
            // Remove existing toasts to prevent stacking
            const existing = document.querySelectorAll('.toast');
            existing.forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // --- Theme & View Logic ---
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadTheme();
            loadViewMode(); // Load layout preference
            loadContent();

            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('view-mode-toggle').addEventListener('click', toggleViewMode);

            // Listen for hash changes to update content dynamically
            window.addEventListener('hashchange', loadContent);
            // Handle bfcache restorations (Back-Forward Cache)
            window.addEventListener('pageshow', (event) => {
                // If page is restored from cache, or just shown, reload content to match URL
                loadContent();
            });
            window.addEventListener('popstate', loadContent);

            // Player Mode Controls
            document.getElementById('btn-next').addEventListener('click', playNext);
            document.getElementById('btn-repeat').addEventListener('click', playCurrent);
        });

        // Player Logic
        function playNext() {
            const lines = Array.from(document.querySelectorAll('.phone-line'));
            if (lines.length === 0) return;

            let currentIndex = lines.findIndex(l => l.classList.contains('touched'));

            // Smart Skip Logic: Find next NON-GHOST line
            let nextIndex = currentIndex;
            let found = false;
            let attempts = 0;

            while (!found && attempts < lines.length) {
                nextIndex++;
                if (nextIndex >= lines.length) nextIndex = 0; // Loop

                // Check if valid target (not ghost)
                if (!lines[nextIndex].classList.contains('ghost-mode')) {
                    found = true;
                }
                attempts++;
            }

            if (found) {
                triggerCall(lines[nextIndex]);
            }
        }

        function playCurrent() {
            const lines = Array.from(document.querySelectorAll('.phone-line'));
            const currentIndex = lines.findIndex(l => l.classList.contains('touched'));

            if (currentIndex !== -1) {
                // **AUTO-VOTE: Increment Connection Count**
                const line = lines[currentIndex];
                const tel = line.getAttribute('data-tel');
                if (tel) {
                    castVote(tel, 'increment');
                }

                triggerCall(line);
            } else {
                if (lines.length > 0) triggerCall(lines[0]);
            }
        }

        function triggerCall(element) {
            // Visualize click
            element.click();
            // The click handler already handles scrolling and calling
        }
    </script>
</body>

</html>